<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>🎟️ Ticket Monitor Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="pink-theme">

  <!-- Header único -->
  <header class="topbar">
    <div class="container topbar-inner">
      <div class="brand">
        <div class="logo-badge" aria-hidden="true">🎟️</div>
        <h1>Ticket Monitor</h1>
        <p class="subtitle">Cute & dynamic musical watcher</p>
      </div>
 
      <div class="controls">
        <div class="search-wrap">
          <span class="search-icon" aria-hidden="true">🔎</span>
          <input id="search" placeholder="Buscar musical..." />
        </div>
        <label class="auto-refresh" aria-live="polite">
          <span class="ar-label">Auto-refresh</span>
          <label class="toggle-switch" title="Auto-refresh">
            <input id="toggle-refresh" type="checkbox" checked />
            <span class="switch" aria-hidden="true"></span>
          </label>
          <span id="ar-state" class="ar-state">ON</span>
        </label>
        <div class="last-checked">⏱️ <small class="lc-label">Last Checked</small> <span id="last-checked">--</span></div>
        <div class="last-checked">📝 <small class="lc-label">Últimos cambios</small> <span id="last-changes">--</span></div>
        <a href="/shows" class="btn small" style="text-decoration:none">Ver cartelera</a>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Hero Banner -->
    <div class="catalog-hero">
      <div class="catalog-hero-inner">
        <h1>🎭 Ticket Monitor</h1>
        <p class="lead">Monitorea disponibilidad de entradas para musicales en tiempo real</p>
        
        <div class="header-actions">
          <a href="{{ telegram_url }}" target="_blank" class="btn btn-telegram">
            <span class="icon">📱</span> Únete a Telegram
          </a>
          <a href="{{ discord_url }}" target="_blank" class="btn btn-discord">
            <span class="icon">💬</span> Únete a Discord
          </a>
        </div>
      </div>
    </div>

    <!-- Dashboard Content con Cards Slideshow -->
    <section class="dashboard-section">
      <div class="section-header">
        <h2>🎪 Musicales Monitoreados</h2>
        <p class="section-subtitle">{{ grouped_urls|length }} musicales en seguimiento</p>
      </div>

      {% if grouped_urls %}
      <div class="musicals-grid">
        {% for item in grouped_urls %}
        <article class="musical-card" data-musical-id="{{ item.musical_id or '' }}">
          <!-- Slideshow de imágenes -->
          <div class="musical-slideshow">
            {% if item.images and item.images|length > 0 %}
              <div class="slideshow-container">
                {% for image in item.images %}
                <div class="slide {% if loop.first %}active{% endif %}">
                  <img src="{{ image }}" alt="{{ item.name }}" loading="lazy">
                </div>
                {% endfor %}
                
                {% if item.images|length > 1 %}
                <button class="slide-prev" onclick="changeSlide(this, -1)" aria-label="Imagen anterior">‹</button>
                <button class="slide-next" onclick="changeSlide(this, 1)" aria-label="Siguiente imagen">›</button>
                
                <div class="slide-dots">
                  {% for image in item.images %}
                  <span class="dot {% if loop.first %}active{% endif %}" onclick="goToSlide(this, {{ loop.index0 }})"></span>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
            {% else %}
              <div class="slideshow-placeholder">
                <div class="placeholder-icon">🎭</div>
                <p>{{ item.name }}</p>
              </div>
            {% endif %}
          </div>

          <!-- Header de la card -->
          <div class="musical-card-header">
            <h3 class="musical-title">{{ item.name }}</h3>
            <div class="badges">
              {% if item.last_updated %}
              <span class="badge badge-success">Actualizado</span>
              {% else %}
              <span class="badge badge-warning">Nuevo</span>
              {% endif %}
              
              {% if item.last_change_type %}
              <span class="badge badge-info">{{ item.last_change_type }}</span>
              {% endif %}
            </div>
          </div>
          
          <!-- Body de la card -->
          <div class="musical-card-body">
            <div class="musical-stats">
              <div class="stat">
                <span class="stat-icon">🔗</span>
                <div class="stat-info">
                  <span class="stat-label">Enlaces</span>
                  <span class="stat-value">{{ item.total_links }}</span>
                </div>
              </div>
              
              {% if item.last_updated %}
              <div class="stat">
                <span class="stat-icon">📅</span>
                <div class="stat-info">
                  <span class="stat-label">Actualizado</span>
                  <span class="stat-value">{{ item.last_updated[:10] }}</span>
                </div>
              </div>
              {% endif %}
            </div>

            <!-- Enlaces monitoreados -->
            <div class="musical-links">
              <h4 class="links-title">
                <span class="icon">🎫</span> 
                Enlaces monitoreados ({{ item.urls|length }})
              </h4>
              <ul class="links-list">
                {% for url in item.urls[:3] %}
                <li>
                  <a href="{{ url }}" target="_blank" rel="noopener noreferrer" class="link-item">
                    <span class="link-icon">🔗</span>
                    <span class="link-text">{{ url|replace('https://', '')|replace('http://', '')[:40] }}...</span>
                    <span class="link-external">↗</span>
                  </a>
                </li>
                {% endfor %}
                
                {% if item.urls|length > 3 %}
                <li class="more-links">
                  <button class="btn-text" onclick="toggleAllLinks(this)">
                    Ver {{ item.urls|length - 3 }} enlaces más...
                  </button>
                </li>
                {% endif %}
              </ul>
              
              {% if item.urls|length > 3 %}
              <ul class="links-list-extra" style="display:none;">
                {% for url in item.urls[3:] %}
                <li>
                  <a href="{{ url }}" target="_blank" rel="noopener noreferrer" class="link-item">
                    <span class="link-icon">🔗</span>
                    <span class="link-text">{{ url|replace('https://', '')|replace('http://', '')[:40] }}...</span>
                    <span class="link-external">↗</span>
                  </a>
                </li>
                {% endfor %}
              </ul>
              {% endif %}
            </div>

            {% if item.last_change_date %}
            <div class="last-change">
              <span class="change-icon">📝</span>
              <span class="change-text">Último cambio: {{ item.last_change_date[:10] }}</span>
            </div>
            {% endif %}
          </div>

          <!-- Footer de la card -->
          <div class="musical-card-footer">
            {% if item.musical_id %}
            <a href="/shows#musical-{{ item.musical_id }}" class="btn btn-primary">
              <span>Ver detalles completos</span>
              <span class="btn-icon">→</span>
            </a>
            {% else %}
            <button class="btn btn-outline" disabled>
              Sin detalles disponibles
            </button>
            {% endif %}
          </div>
        </article>
        {% endfor %}
      </div>
      {% else %}
      <div class="empty-state">
        <div class="empty-icon">🎭</div>
        <h3>No hay musicales monitoreados</h3>
        <p>Añade tu primer musical para empezar a monitorear entradas</p>
        <button class="btn btn-primary" onclick="document.getElementById('inline-suggest').scrollIntoView({behavior: 'smooth'})">
          <span class="icon">✨</span>
          Sugerir Musical
        </button>
      </div>
      {% endif %}
    </section>

    <!-- Quick Stats -->
    <section class="stats-section">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">🎫</div>
          <div class="stat-content">
            <h4>Total Enlaces</h4>
            <p class="stat-number">
              {% set total = namespace(value=0) %}
              {% for item in grouped_urls %}
                {% set total.value = total.value + item.total_links %}
              {% endfor %}
              {{ total.value }}
            </p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">🎪</div>
          <div class="stat-content">
            <h4>Musicales</h4>
            <p class="stat-number">{{ grouped_urls|length }}</p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">⚡</div>
          <div class="stat-content">
            <h4>Estado</h4>
            <p class="stat-status">✅ Activo</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Inline suggestion card -->
    <section id="inline-suggest" class="suggestion-card fade-in" aria-labelledby="suggest-inline-title">
      <h3 id="suggest-inline-title">💌 Enviar sugerencia</h3>
      <form id="inline-suggest-form" class="suggestion-form" novalidate>
        <div class="row">
          <label>Nombre del Musical *<br>
            <input name="siteName" type="text" placeholder="Ej. The Book of Mormon" required>
          </label>
          <label>URL del sitio *<br>
            <input name="siteUrl" type="url" placeholder="https://tickets.ejemplo.com" required>
          </label>
        </div>

        <label>¿Por qué deberíamos monitorearlo?<br>
          <textarea name="reason" rows="3" placeholder="Opcional: cuéntanos por qué te interesa este musical..."></textarea>
        </label>

        <div class="suggest-controls">
          <button type="submit" class="btn primary">✨ Enviar Sugerencia</button>
          <button type="reset" class="btn ghost">Limpiar</button>
          <div id="inline-suggest-status" class="suggest-status" aria-live="polite"></div>
        </div>
      </form>
    </section>
  </main>

  <footer class="footer">
    <small>Made with 💖 — dynamic cute monitor</small>
  </footer>

  <!-- Join Channels Popup -->
  <div id="join-channels-popup" class="join-popup" style="display:none;">
    <div class="join-popup-overlay"></div>
    <div class="join-popup-inner">
      <button class="join-close" id="join-close-btn" aria-label="Cerrar" type="button">✕</button>
      
      <div class="join-header">
        <h2>🎭 ¡Bienvenido a Ticket Monitor!</h2>
        <p>Únete a nuestra comunidad para recibir alertas instantáneas</p>
      </div>
      
      <div class="join-channels">
        <a href="{{ telegram_url }}" 
           target="_blank" 
           rel="noopener noreferrer" 
           class="join-btn telegram"
           onclick="localStorage.setItem('joinChannelsShown_v1', 'true')">
          <svg class="join-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.14.18-.357.295-.6.295-.002 0-.003 0-.005 0l.213-3.053 5.56-5.023c.242-.213-.054-.334-.373-.121l-6.869 4.326-2.96-.924c-.64-.203-.658-.64.135-.954l11.566-4.458c.538-.196 1.006.128.832.941z"/>
          </svg>
          <span>Bot de Telegram</span>
        </a>
        
        <a href="{{ discord_url }}" 
           target="_blank" 
           rel="noopener noreferrer" 
           class="join-btn discord"
           onclick="localStorage.setItem('joinChannelsShown_v1', 'true')">
          <svg class="join-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
          </svg>
          <span>Servidor de Discord</span>
        </a>
      </div>
      
      <button class="join-skip" id="join-skip-btn" type="button">
        Recordar más tarde
      </button>
    </div>
  </div>

  <!-- Scripts -->
  <script src="{{ url_for('static', filename='main.js') }}"></script>
  <script>
    // ==================== SLIDESHOW FUNCTIONALITY ====================
    function changeSlide(button, direction) {
      const container = button.closest('.slideshow-container');
      const slides = container.querySelectorAll('.slide');
      const dots = container.querySelectorAll('.dot');
      
      let currentIndex = Array.from(slides).findIndex(s => s.classList.contains('active'));
      slides[currentIndex].classList.remove('active');
      dots[currentIndex]?.classList.remove('active');
      
      currentIndex = (currentIndex + direction + slides.length) % slides.length;
      
      slides[currentIndex].classList.add('active');
      dots[currentIndex]?.classList.add('active');
    }
    
    function goToSlide(dot, index) {
      const container = dot.closest('.slideshow-container');
      const slides = container.querySelectorAll('.slide');
      const dots = container.querySelectorAll('.dot');
      
      slides.forEach(s => s.classList.remove('active'));
      dots.forEach(d => d.classList.remove('active'));
      
      slides[index].classList.add('active');
      dots[index].classList.add('active');
    }
    
    // Auto-play slideshow (opcional)
    setInterval(() => {
      document.querySelectorAll('.slideshow-container').forEach(container => {
        if (container.querySelectorAll('.slide').length > 1) {
          const nextBtn = container.querySelector('.slide-next');
          if (nextBtn) changeSlide(nextBtn, 1);
        }
      });
    }, 5000);

    // ==================== TOGGLE EXTRA LINKS ====================
    function toggleAllLinks(button) {
      const card = button.closest('.musical-card');
      const extraLinks = card.querySelector('.links-list-extra');
      
      if (extraLinks.style.display === 'none') {
        extraLinks.style.display = 'block';
        button.textContent = 'Ver menos...';
      } else {
        extraLinks.style.display = 'none';
        const hiddenCount = extraLinks.querySelectorAll('li').length;
        button.textContent = `Ver ${hiddenCount} enlaces más...`;
      }
    }

    // ==================== SUGGESTION FORM ====================
    document.getElementById('inline-suggest-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const status = document.getElementById('inline-suggest-status');
      const form = e.target;
      
      const data = {
        siteName: form.siteName.value.trim(),
        siteUrl: form.siteUrl.value.trim(),
        reason: form.reason.value.trim()
      };
      
      if (!data.siteName || !data.siteUrl) {
        status.textContent = '⚠️ Por favor completa los campos obligatorios';
        status.style.color = '#dc3545';
        return;
      }
      
      status.textContent = '⏳ Enviando...';
      status.style.color = '#6c757d';
      
      try {
        const res = await fetch('/api/suggest-site', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await res.json();
        
        if (res.ok && result.ok) {
          status.textContent = '✅ ¡Gracias! Tu sugerencia ha sido enviada';
          status.style.color = '#28a745';
          form.reset();
          setTimeout(() => { status.textContent = ''; }, 3000);
        } else {
          status.textContent = '❌ Error: ' + (result.error || 'Intenta de nuevo');
          status.style.color = '#dc3545';
        }
      } catch (err) {
        status.textContent = '❌ Error de conexión';
        status.style.color = '#dc3545';
      }
    });

    // ==================== JOIN POPUP ====================
    const joinPopup = document.getElementById('join-channels-popup');
    const joinCloseBtn = document.getElementById('join-close-btn');
    const joinSkipBtn = document.getElementById('join-skip-btn');
    
    if (!localStorage.getItem('joinChannelsShown_v1')) {
      setTimeout(() => {
        joinPopup.style.display = 'block';
      }, 2000);
    }
    
    joinCloseBtn?.addEventListener('click', () => {
      joinPopup.style.display = 'none';
      localStorage.setItem('joinChannelsShown_v1', 'true');
    });
    
    joinSkipBtn?.addEventListener('click', () => {
      joinPopup.style.display = 'none';
    });
  </script>
</body>
</html>