<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üìÖ Calendario de Musicales - Ticket Monitor</title>
  
  <link rel="stylesheet" href="/static/css/style.css">
  
  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
  
  <style>
    .calendar-container {
      max-width: 1400px;
      margin: 40px auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    #calendar {
      margin-top: 20px;
    }

    /* Estilo personalizado para eventos */
    .fc-event {
      border-radius: 4px;
      padding: 2px 4px;
      font-size: 0.85rem;
      cursor: pointer;
      border: none !important;
      position: relative;
    }

    .fc-event:hover {
      opacity: 0.9;
      transform: scale(1.02);
      z-index: 100;
    }

    /* Tooltip/Card hover mejorado */
    .event-item {
      position: relative;
      cursor: pointer;
    }

    .event-tooltip {
      position: fixed; /* ‚Üê Cambio clave: fixed en vez de absolute */
      display: none;
      background: white;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
      z-index: 9999;
      min-width: 300px;
      max-width: 400px;
      pointer-events: none; /* No interfiere con el hover */
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .event-item:hover .event-tooltip {
      display: block;
      opacity: 1;
    }

    /* Flecha del tooltip (arriba o abajo seg√∫n posici√≥n) */
    .event-tooltip::before {
      content: '';
      position: absolute;
      width: 0;
      height: 0;
      border: 8px solid transparent;
    }

    /* Flecha apuntando abajo (tooltip arriba del elemento) */
    .event-tooltip.tooltip-top::before {
      bottom: -16px;
      left: 50%;
      transform: translateX(-50%);
      border-top-color: white;
      border-bottom: none;
    }

    /* Flecha apuntando arriba (tooltip abajo del elemento) */
    .event-tooltip.tooltip-bottom::before {
      top: -16px;
      left: 50%;
      transform: translateX(-50%);
      border-bottom-color: white;
      border-top: none;
    }

    /* Contenido del tooltip */
    .tooltip-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 2px solid #f0f0f0;
    }

    .tooltip-icon {
      font-size: 2rem;
    }

    .tooltip-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: #333;
      margin: 0;
    }

    .tooltip-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .tooltip-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: #666;
    }

    .tooltip-row strong {
      color: #333;
      min-width: 80px;
    }

    .tooltip-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .tooltip-badge.available {
      background: #d4edda;
      color: #155724;
    }

    .tooltip-badge.sold-out {
      background: #f8d7da;
      color: #721c24;
    }

    /* Filtros */
    .calendar-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      padding: 15px;
      background: var(--light-pink);
      border-radius: 8px;
    }

    .filter-chip {
      padding: 8px 16px;
      border-radius: 20px;
      border: 2px solid transparent;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      color: white;
      transition: all 0.3s ease;
    }

    .filter-chip:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .filter-chip.active {
      border-color: white;
      box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
    }

    .filter-all { background: #34495e; }

    /* Responsive */
    @media (max-width: 768px) {
      .event-tooltip {
        min-width: 250px;
        max-width: 90vw;
      }
    }
  </style>

  <!-- A√±ade esto en el <head> -->
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/scale.css"/>

  <script>
    // Inicializar tooltips con Tippy.js
    document.addEventListener('DOMContentLoaded', () => {
      tippy('.event-item', {
        content(reference) {
          const template = reference.querySelector('.event-tooltip');
          return template ? template.innerHTML : 'Sin informaci√≥n';
        },
        allowHTML: true,
        placement: 'auto', // ‚Üê Se posiciona autom√°ticamente
        interactive: true,
        animation: 'scale',
        theme: 'light-border',
        maxWidth: 400,
        offset: [0, 10],
      });
    });
  </script>

  <style>
    /* Tema custom para Tippy.js */
    .tippy-box[data-theme~='light-border'] {
      background-color: white;
      color: #333;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
      border-radius: 12px;
    }

    .tippy-box[data-theme~='light-border'][data-placement^='top'] > .tippy-arrow::before {
      border-top-color: white;
    }

    .tippy-box[data-theme~='light-border'][data-placement^='bottom'] > .tippy-arrow::before {
      border-bottom-color: white;
    }

    /* Ocultar el tooltip inline (Tippy lo clonar√°) */
    .event-tooltip {
      display: none;
    }
  </style>
</head>
<body class="pink-theme">

  <!-- Header -->
  <header class="topbar">
    <div class="container topbar-inner">
      <div class="brand">
        <div class="logo-badge" aria-hidden="true">üìÖ</div>
        <h1>Calendario de Musicales</h1>
      </div>
      
      <div class="controls">
        <a href="/" class="btn small" style="text-decoration:none">‚Üê Volver al Dashboard</a>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Hero -->
    <div class="catalog-hero">
      <div class="catalog-hero-inner">
        <h1>üìÖ Calendario de Musicales 2025-2026</h1>
        <p class="lead">Pasa el rat√≥n sobre un musical para ver m√°s informaci√≥n</p>
      </div>
    </div>

    <div class="calendar-container">
      <!-- Filtros -->
      <div class="calendar-filters">
        <button class="filter-chip filter-all active" data-musical="all">
          üìã Todos los musicales
        </button>
        <button class="filter-chip event-wicked" data-musical="wicked">
          Wicked
        </button>
        <button class="filter-chip event-book-mormon" data-musical="the book of mormon">
          The Book of Mormon
        </button>
        <button class="filter-chip event-les-miserables" data-musical="les mis√©rables">
          Les Mis√©rables
        </button>
        <button class="filter-chip event-rey-leon" data-musical="el rey le√≥n">
          El Rey Le√≥n
        </button>
        <button class="filter-chip event-cabaret" data-musical="cabaret">
          Cabaret
        </button>
        <button class="filter-chip event-houdini" data-musical="houdini">
          Houdini
        </button>
      </div>

      <!-- Calendario -->
      <div id="calendar"></div>
    </div>
  </main>

  <!-- Tooltip flotante -->
  <div id="musical-tooltip" class="musical-tooltip"></div>

  <footer class="footer">
    <small>Made with üíñ ‚Äî Musical Calendar Monitor</small>
  </footer>

  <!-- FullCalendar JS -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const calendarEl = document.getElementById('calendar');
      const tooltipEl = document.getElementById('musical-tooltip');
      let currentFilter = 'all';
      let hideTimeout;
      let isMouseOverTooltip = false;
      let isMouseOverEvent = false;
      
      // Cargar eventos desde el servidor
      fetch('/api/calendar-events')
        .then(response => response.json())
        .then(events => {
          console.log(`‚úÖ Cargados ${events.length} eventos`);
          initCalendar(events);
        })
        .catch(error => {
          console.error('Error loading events:', error);
          calendarEl.innerHTML = '<p style="text-align:center; color:#e74c3c; padding:40px;">‚ùå Error al cargar el calendario</p>';
        });

      function initCalendar(allEvents) {
        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          locale: 'es',
          firstDay: 1,
          height: 'auto',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,listMonth'
          },
          buttonText: {
            today: 'Hoy',
            month: 'Mes',
            list: 'Lista'
          },
          events: allEvents,
          
          // Hover para mostrar tooltip
          eventMouseEnter: function(info) {
            clearTimeout(hideTimeout);
            isMouseOverEvent = true;
            showTooltip(info.event, info.jsEvent);
          },
          
          eventMouseLeave: function() {
            isMouseOverEvent = false;
            hideTimeout = setTimeout(() => {
              if (!isMouseOverTooltip && !isMouseOverEvent) {
                tooltipEl.classList.remove('active');
              }
            }, 200);
          }
        });

        calendar.render();

        // Mantener tooltip visible al hacer hover sobre √©l
        tooltipEl.addEventListener('mouseenter', () => {
          clearTimeout(hideTimeout);
          isMouseOverTooltip = true;
        });

        tooltipEl.addEventListener('mouseleave', () => {
          isMouseOverTooltip = false;
          hideTimeout = setTimeout(() => {
            if (!isMouseOverEvent) {
              tooltipEl.classList.remove('active');
            }
          }, 200);
        });

        // Filtros
        document.querySelectorAll('.filter-chip').forEach(chip => {
          chip.addEventListener('click', function() {
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            
            const musical = this.dataset.musical.toLowerCase();
            
            if (musical === 'all') {
              calendar.removeAllEvents();
              calendar.addEventSource(allEvents);
            } else {
              const filtered = allEvents.filter(e => 
                e.extendedProps.musical.toLowerCase() === musical
              );
              calendar.removeAllEvents();
              calendar.addEventSource(filtered);
            }
          });
        });
      }

      function showTooltip(event, mouseEvent) {
        const props = event.extendedProps || {};
        
        // ARREGLADO: Usar placeholder si no hay imagen o si es default.jpg
        let image = props.image || '';
        
        // Si la imagen es vac√≠a o termina en default.jpg, usar placeholder
        if (!image || image.includes('default.jpg')) {
          image = `https://via.placeholder.com/320x180/ff69b4/ffffff?text=${encodeURIComponent(event.title.substring(0, 20))}`;
        }
        
        const description = props.description || 'Disfruta de este incre√≠ble musical en Madrid';
        const location = props.location || 'Madrid';
        const url = props.url || '#';
        
        // Crear enlace de Google Maps
        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location + ', Madrid')}`;
        
        // Debug
        console.log('üé≠ Musical:', event.title);
        console.log('üì∏ Imagen:', image);
        console.log('üîó URL:', url);
        console.log('üìç Maps:', mapsUrl);
        
        tooltipEl.innerHTML = `
          <img 
            src="${image}" 
            alt="${event.title}" 
            class="tooltip-image" 
            onerror="this.src='https://via.placeholder.com/320x180/ff69b4/ffffff?text=Musical';"
          >
          <div class="tooltip-content">
            <h3 class="tooltip-title">${event.title}</h3>
            <div class="tooltip-meta">
              <div class="tooltip-meta-item">
                <span>üìç</span>
                <a href="${mapsUrl}" target="_blank" class="tooltip-location-link" onclick="event.stopPropagation()">
                  ${location}
                </a>
              </div>
            </div>
            <p class="tooltip-description">${description}</p>
            <div class="tooltip-buttons">
              ${url !== '#' ? `<a href="${url}" target="_blank" class="tooltip-button tooltip-button-primary" onclick="event.stopPropagation()">üéüÔ∏è Comprar Entradas</a>` : ''}
              <a href="${mapsUrl}" target="_blank" class="tooltip-button tooltip-button-secondary" onclick="event.stopPropagation()">üó∫Ô∏è Ver en Google Maps</a>
            </div>
          </div>
        `;
        
        // Posicionar tooltip
        const tooltipWidth = 320;
        const tooltipHeight = 550;
        
        let left = mouseEvent.pageX + 15;
        let top = mouseEvent.pageY - 50;
        
        if (left + tooltipWidth > window.innerWidth) {
          left = mouseEvent.pageX - tooltipWidth - 15;
        }
        
        if (top + tooltipHeight > window.innerHeight + window.scrollY) {
          top = window.innerHeight + window.scrollY - tooltipHeight - 20;
        }
        
        if (top < window.scrollY) {
          top = window.scrollY + 20;
        }
        
        tooltipEl.style.left = left + 'px';
        tooltipEl.style.top = top + 'px';
        tooltipEl.classList.add('active');
      }
    });
  </script>

  <script>
    // ==================== POSICIONAMIENTO INTELIGENTE DEL TOOLTIP ====================
    document.addEventListener('DOMContentLoaded', () => {
      const eventItems = document.querySelectorAll('.event-item');

      eventItems.forEach(item => {
        const tooltip = item.querySelector('.event-tooltip');
        if (!tooltip) return;

        item.addEventListener('mouseenter', (e) => {
          positionTooltip(item, tooltip);
        });

        // Reposicionar al mover el mouse (opcional, para mejor experiencia)
        item.addEventListener('mousemove', () => {
          positionTooltip(item, tooltip);
        });
      });

      function positionTooltip(item, tooltip) {
        const itemRect = item.getBoundingClientRect();
        const tooltipRect = tooltip.getBoundingClientRect();
        const viewportHeight = window.innerHeight;
        const viewportWidth = window.innerWidth;

        // Calcular espacio disponible arriba y abajo
        const spaceAbove = itemRect.top;
        const spaceBelow = viewportHeight - itemRect.bottom;

        // Decidir si mostrar arriba o abajo
        const showAbove = spaceBelow < tooltipRect.height + 20 && spaceAbove > spaceBelow;

        if (showAbove) {
          // Mostrar arriba
          tooltip.style.top = `${itemRect.top - tooltipRect.height - 10}px`;
          tooltip.classList.add('tooltip-top');
          tooltip.classList.remove('tooltip-bottom');
        } else {
          // Mostrar abajo
          tooltip.style.top = `${itemRect.bottom + 10}px`;
          tooltip.classList.add('tooltip-bottom');
          tooltip.classList.remove('tooltip-top');
        }

        // Centrar horizontalmente, pero ajustar si se sale de la pantalla
        let left = itemRect.left + (itemRect.width / 2) - (tooltipRect.width / 2);

        // Ajustar si se sale por la izquierda
        if (left < 10) {
          left = 10;
        }

        // Ajustar si se sale por la derecha
        if (left + tooltipRect.width > viewportWidth - 10) {
          left = viewportWidth - tooltipRect.width - 10;
        }

        tooltip.style.left = `${left}px`;
      }
    });
  </script>
</body>
</html>