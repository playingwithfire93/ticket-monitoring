<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üìÖ Calendario de Musicales - Ticket Monitor</title>
  
  <link rel="stylesheet" href="/static/css/style.css">
  
  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
  
  <style>
    .calendar-container {
      max-width: 1400px;
      margin: 40px auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    #calendar {
      margin-top: 20px;
    }

    /* Estilo personalizado para eventos */
    .fc-event {
      border-radius: 4px;
      padding: 2px 4px;
      font-size: 0.85rem;
      cursor: pointer;
      border: none !important;
      position: relative;
    }

    .fc-event:hover {
      opacity: 0.9;
      transform: scale(1.02);
      z-index: 100;
    }

    /* TOOLTIP CARD */
    .musical-tooltip {
      position: fixed;
      display: none;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.3);
      width: 320px;
      z-index: 9999;
      overflow: hidden;
      animation: fadeIn 0.2s ease;
      pointer-events: auto;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .musical-tooltip.active {
      display: block;
    }

    .tooltip-image {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-bottom: 3px solid var(--primary-pink);
    }

    .tooltip-content {
      padding: 20px;
    }

    .tooltip-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--primary-pink);
      margin: 0 0 10px 0;
    }

    .tooltip-meta {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
      font-size: 0.9rem;
      color: #666;
    }

    .tooltip-meta-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tooltip-location-link {
      color: #3498db;
      text-decoration: none;
      transition: color 0.2s ease;
    }

    .tooltip-location-link:hover {
      color: #2980b9;
      text-decoration: underline;
    }

    .tooltip-description {
      font-size: 0.9rem;
      color: #555;
      line-height: 1.5;
      margin-bottom: 15px;
    }

    .tooltip-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .tooltip-button {
      display: inline-block;
      width: 100%;
      padding: 12px;
      text-align: center;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .tooltip-button-primary {
      background: linear-gradient(135deg, var(--primary-pink), var(--secondary-pink));
      color: white;
    }

    .tooltip-button-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(255, 105, 180, 0.4);
    }

    .tooltip-button-secondary {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
    }

    .tooltip-button-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
    }

    /* Colores por tipo de musical */
    .event-wicked { background-color: #9b59b6 !important; }
    .event-book-mormon { background-color: #e74c3c !important; }
    .event-les-miserables { background-color: #3498db !important; }
    .event-rey-leon { background-color: #f39c12 !important; }
    .event-cabaret { background-color: #34495e !important; }
    .event-houdini { background-color: #16a085 !important; }
    .event-cenicienta { background-color: #e91e63 !important; }
    .event-rent { background-color: #1abc9c !important; }
    .event-six { background-color: #e91e63 !important; }
    .event-default { background-color: #95a5a6 !important; }

    /* Filtros */
    .calendar-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      padding: 15px;
      background: var(--light-pink);
      border-radius: 8px;
    }

    .filter-chip {
      padding: 8px 16px;
      border-radius: 20px;
      border: 2px solid transparent;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      color: white;
      transition: all 0.3s ease;
    }

    .filter-chip:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .filter-chip.active {
      border-color: white;
      box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
    }

    .filter-all { background: #34495e; }
  </style>
</head>
<body class="pink-theme">

  <!-- Header -->
  <header class="topbar">
    <div class="container topbar-inner">
      <div class="brand">
        <div class="logo-badge" aria-hidden="true">üìÖ</div>
        <h1>Calendario de Musicales</h1>
      </div>
      
      <div class="controls">
        <a href="/" class="btn small" style="text-decoration:none">‚Üê Volver al Dashboard</a>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Hero -->
    <div class="catalog-hero">
      <div class="catalog-hero-inner">
        <h1>üìÖ Calendario de Musicales 2025-2026</h1>
        <p class="lead">Pasa el rat√≥n sobre un musical para ver m√°s informaci√≥n</p>
      </div>
    </div>

    <div class="calendar-container">
      <!-- Filtros -->
      <div class="calendar-filters">
        <button class="filter-chip filter-all active" data-musical="all">
          üìã Todos los musicales
        </button>
        <button class="filter-chip event-wicked" data-musical="wicked">
          Wicked
        </button>
        <button class="filter-chip event-book-mormon" data-musical="the book of mormon">
          The Book of Mormon
        </button>
        <button class="filter-chip event-les-miserables" data-musical="les mis√©rables">
          Les Mis√©rables
        </button>
        <button class="filter-chip event-rey-leon" data-musical="el rey le√≥n">
          El Rey Le√≥n
        </button>
        <button class="filter-chip event-cabaret" data-musical="cabaret">
          Cabaret
        </button>
        <button class="filter-chip event-houdini" data-musical="houdini">
          Houdini
        </button>
      </div>

      <!-- Calendario -->
      <div id="calendar"></div>
    </div>
  </main>

  <!-- Tooltip flotante -->
  <div id="musical-tooltip" class="musical-tooltip"></div>

  <footer class="footer">
    <small>Made with üíñ ‚Äî Musical Calendar Monitor</small>
  </footer>

  <!-- FullCalendar JS -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const calendarEl = document.getElementById('calendar');
      const tooltipEl = document.getElementById('musical-tooltip');
      let currentFilter = 'all';
      let hideTimeout;
      let isMouseOverTooltip = false;
      let isMouseOverEvent = false;
      
      // Cargar eventos desde el servidor
      fetch('/api/calendar-events')
        .then(response => response.json())
        .then(events => {
          initCalendar(events);
        })
        .catch(error => {
          console.error('Error loading events:', error);
          calendarEl.innerHTML = '<p style="text-align:center; color:#e74c3c; padding:40px;">‚ùå Error al cargar el calendario</p>';
        });

      function initCalendar(allEvents) {
        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          locale: 'es',
          firstDay: 1,
          height: 'auto',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,listMonth'
          },
          buttonText: {
            today: 'Hoy',
            month: 'Mes',
            list: 'Lista'
          },
          events: allEvents,
          
          // Hover para mostrar tooltip
          eventMouseEnter: function(info) {
            clearTimeout(hideTimeout);
            isMouseOverEvent = true;
            showTooltip(info.event, info.jsEvent);
          },
          
          eventMouseLeave: function() {
            isMouseOverEvent = false;
            hideTimeout = setTimeout(() => {
              if (!isMouseOverTooltip && !isMouseOverEvent) {
                tooltipEl.classList.remove('active');
              }
            }, 200);
          }
        });

        calendar.render();

        // Mantener tooltip visible al hacer hover sobre √©l
        tooltipEl.addEventListener('mouseenter', () => {
          clearTimeout(hideTimeout);
          isMouseOverTooltip = true;
        });

        tooltipEl.addEventListener('mouseleave', () => {
          isMouseOverTooltip = false;
          hideTimeout = setTimeout(() => {
            if (!isMouseOverEvent) {
              tooltipEl.classList.remove('active');
            }
          }, 200);
        });

        // Filtros
        document.querySelectorAll('.filter-chip').forEach(chip => {
          chip.addEventListener('click', function() {
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            
            const musical = this.dataset.musical.toLowerCase();
            
            if (musical === 'all') {
              calendar.removeAllEvents();
              calendar.addEventSource(allEvents);
            } else {
              const filtered = allEvents.filter(e => 
                e.extendedProps.musical.toLowerCase() === musical
              );
              calendar.removeAllEvents();
              calendar.addEventSource(filtered);
            }
          });
        });
      }

      function showTooltip(event, mouseEvent) {
        const props = event.extendedProps;
        
        // Validar que la imagen existe
        const image = props.image && props.image !== '' 
          ? props.image 
          : `https://via.placeholder.com/320x180/ff69b4/ffffff?text=${encodeURIComponent(event.title.substring(0, 20))}`;
        
        const description = props.description || 'Disfruta de este incre√≠ble musical en Madrid';
        const location = props.location || 'Madrid';
        const url = props.url || '#';
        
        // Crear enlace de Google Maps
        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location + ', Madrid')}`;
        
        // Debug
        console.log('üé≠ Musical:', event.title);
        console.log('üì∏ Imagen:', image);
        console.log('üîó URL:', url);
        console.log('üìç Maps:', mapsUrl);
        
        tooltipEl.innerHTML = `
          <img 
            src="${image}" 
            alt="${event.title}" 
            class="tooltip-image" 
            onerror="console.error('‚ùå Error cargando:', this.src); this.src='https://via.placeholder.com/320x180/ff69b4/ffffff?text=Musical';"
          >
          <div class="tooltip-content">
            <h3 class="tooltip-title">${event.title}</h3>
            <div class="tooltip-meta">
              <div class="tooltip-meta-item">
                <span>üìç</span>
                <a href="${mapsUrl}" target="_blank" class="tooltip-location-link" onclick="event.stopPropagation()">
                  ${location}
                </a>
              </div>
            </div>
            <p class="tooltip-description">${description}</p>
            <div class="tooltip-buttons">
              ${url !== '#' ? `<a href="${url}" target="_blank" class="tooltip-button tooltip-button-primary" onclick="event.stopPropagation()">üéüÔ∏è Comprar Entradas</a>` : ''}
              <a href="${mapsUrl}" target="_blank" class="tooltip-button tooltip-button-secondary" onclick="event.stopPropagation()">üó∫Ô∏è Ver en Google Maps</a>
            </div>
          </div>
        `;
        
        // Posicionar tooltip
        const tooltipWidth = 320;
        const tooltipHeight = 550; // Aumentado por el bot√≥n extra
        
        let left = mouseEvent.pageX + 15;
        let top = mouseEvent.pageY - 50;
        
        if (left + tooltipWidth > window.innerWidth) {
          left = mouseEvent.pageX - tooltipWidth - 15;
        }
        
        if (top + tooltipHeight > window.innerHeight + window.scrollY) {
          top = window.innerHeight + window.scrollY - tooltipHeight - 20;
        }
        
        if (top < window.scrollY) {
          top = window.scrollY + 20;
        }
        
        tooltipEl.style.left = left + 'px';
        tooltipEl.style.top = top + 'px';
        tooltipEl.classList.add('active');
      }
    });
  </script>
</body>
</html>