<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üéüÔ∏è Ticket Monitor Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <header class="topbar">
    <div class="container topbar-inner">
      <div class="brand">
        <!-- cute rounded badge (fallback to emoji) -->
        <div class="logo-badge" aria-hidden="true">üéüÔ∏è</div>
         <h1>Ticket Monitor</h1>
         <p class="subtitle">Cute & dynamic musical watcher</p>
       </div>
 
       <div class="controls">
        <div class="search-wrap">
          <span class="search-icon" aria-hidden="true">üîé</span>
          <input id="search" placeholder="Buscar musical..." />
        </div>
        <label class="auto-refresh" aria-live="polite">
          <span class="ar-label">Auto-refresh</span>
          <label class="toggle-switch" title="Auto-refresh">
            <input id="toggle-refresh" type="checkbox" checked />
            <span class="switch" aria-hidden="true"></span>
          </label>
          <span id="ar-state" class="ar-state">ON</span>
        </label>
         <div class="last-checked">‚è±Ô∏è <small class="lc-label">Last Checked</small> <span id="last-checked">--</span></div>
        <button id="test-telegram-btn" class="btn small telegram-btn"><span class="tg-icon" aria-hidden="true">‚úàÔ∏è</span> Test Telegram</button>
       </div>
     </div>
   </header>

  <main class="container">
    <!-- Musicals grid with per-card mini-slideshow -->
    <section class="home-listing">
      <div class="home-header">
        <h2>Musicales destacados</h2>
        <p class="subtitle">Elige un musical para ver sus enlaces y cambios.</p>
      </div>
      <div class="grid home-grid" id="musicals-grid">
        {% for c in musicals_cards %}
        <article class="card musical-card" data-title="{{ c.title }}">
          <div class="slideshow" data-interval="5000">
            {% for img in c.images %}
              <img src="{{ img }}" alt="{{ c.title }}" />
            {% endfor %}
            <button class="slideshow-prev" aria-label="Anterior">‚Äπ</button>
            <button class="slideshow-next" aria-label="Siguiente">‚Ä∫</button>
          </div>
          <div class="card-body">
            <h3 class="card-title">{{ c.title }}</h3>
            <p class="meta">{{ c.urlCount }} enlace(s) monitorizados</p>
            <div class="card-actions">
              <button class="btn btn-primary js-view-urls" data-musical="{{ c.title }}">Ver enlaces</button>
              <a class="btn btn-outline" href="/shows" target="_self">Cartelera</a>
            </div>
          </div>
        </article>
        {% endfor %}
      </div>
    </section>

    <!-- Table / List -->
    <section id="list" class="list-section fade-in">
      <table class="musicals-table" aria-label="Monitored musicals">
        <thead>
          <tr>
            <th aria-hidden="true"></th>
            <th>Musical</th>
            <th>URLs</th>
            <th>Cambios</th>
          </tr>
        </thead>
        <tbody id="table-body">
          <!-- populated by main.js -->
        </tbody>
      </table>

      <div id="no-data" class="no-data" hidden>No musicals yet ‚Äî add one ‚ú®</div>
    </section>

    <!-- Inline suggestion card (non-overlay) -->
    <section id="inline-suggest" class="suggestion-card fade-in" aria-labelledby="suggest-inline-title">
      <h3 id="suggest-inline-title">Enviar sugerencia</h3>
      <form id="inline-suggest-form" class="suggestion-form" novalidate>
        <div class="row">
          <label>Nombre (opcional)<br><input name="name" type="text" placeholder="Tu nombre"></label>
          <label>Email (opcional)<br><input name="email" type="email" placeholder="tu@correo.com"></label>
        </div>

        <div class="row">
          <label>Musical<br><input name="musical" type="text" placeholder="Ej. The Book of Mormon"></label>
          <label>Link<br><input name="url" type="url" placeholder="https://tickets.ejemplo.com/..."></label>
        </div>

        <label>Comentario / mensaje<br><textarea name="comment" rows="4" required placeholder="Escribe tu sugerencia o comentario..."></textarea></label>

        <div class="suggest-controls">
          <button type="submit" class="btn primary">Enviar</button>
          <button type="reset" class="btn ghost">Limpiar</button>
          <div id="inline-suggest-status" class="suggest-status" aria-live="polite"></div>
        </div>
      </form>
    </section>
  </main>

  <!-- Modal para mostrar cambios (necesario para showChangesForItem) -->
  <div id="modal" class="modal" aria-hidden="true" style="display:none;">
    <div class="modal-inner" role="dialog" aria-modal="true" aria-labelledby="modal-title" style="max-width:820px;">
      <button id="modal-close" class="modal-close" aria-label="Cerrar" style="position:absolute;right:12px;top:10px;background:transparent;border:0;font-size:20px;cursor:pointer">√ó</button>
      <h3 id="modal-title" style="margin:0 0 .5rem 0;font-size:1.05rem;font-weight:700"></h3>
      <div id="modal-list"></div>
    </div>
  </div>

  <footer class="footer">
    <small>Made with üíñ ‚Äî dynamic cute monitor</small>
  </footer>

  <div id="telegram-popup" class="notification-popup" role="dialog" aria-modal="true" aria-hidden="true" style="display:block;opacity:0;pointer-events:none;">
    <div>
      <strong class="np-title">√önete a nuestro Telegram</strong>
      <div class="np-body" style="margin-top:6px;font-weight:600">Recibe alertas y novedades en tiempo real.</div>
    </div>
    <div style="display:flex;gap:8px;margin-left:auto;align-items:center">
      <a id="telegram-join" class="btn primary" href="https://t.me/TheBookOfMormonTicketsbot" target="_blank" rel="noopener noreferrer" style="text-decoration:none;padding:8px 12px">Unirme</a>
      <button id="telegram-dismiss" class="btn ghost" style="padding:8px 10px">No, gracias</button>
    </div>
    <button class="np-close" aria-label="Cerrar" id="telegram-close" style="position:absolute;top:8px;right:10px;background:transparent;border:0;font-size:18px;color:var(--accent)">√ó</button>
  </div>

  <button id="open-suggest" class="btn small">Sugerencias</button>

  <!-- Suggestion modal (paste once inside <body>) -->
  <div id="suggest-modal" class="modal" aria-hidden="true" style="display:none;">
    <div class="modal-inner" role="dialog" aria-modal="true" aria-labelledby="suggest-title">
      <button class="modal-close" id="suggest-close" aria-label="Cerrar" onclick="document.getElementById('suggest-modal').style.display='none'">√ó</button>
      <h3 id="suggest-title">Enviar sugerencia</h3>
      <form id="suggest-form">
        <label>Nombre (opcional)<br><input name="name" type="text" placeholder="Tu nombre"></label>
        <label>Email (opcional)<br><input name="email" type="email" placeholder="tu@correo.com"></label>
        <label>Mensaje<br><textarea name="message" rows="4" required placeholder="Escribe tu sugerencia..."></textarea></label>
        <div style="display:flex;gap:.5rem;align-items:center;margin-top:.5rem">
          <button type="submit" class="btn primary">Enviar</button>
          <button type="button" class="btn ghost" id="suggest-cancel" onclick="document.getElementById('suggest-modal').style.display='none'">Cancelar</button>
          <div id="suggest-status" style="margin-left:auto;font-size:.9rem"></div>
        </div>
      </form>
    </div>
  </div>

  <!-- A√±adir widget de calendario (peque√±o preview + maximizable) -->
<div id="calendar-widget" class="calendar-widget">
  <div class="cw-header">
    <strong>Calendario</strong>
    <div class="cw-actions">
      <button id="cw-max-btn" class="cw-btn" title="Maximizar">‚§¢</button>
    </div>
  </div>
  <div class="cw-body">
    <iframe id="cw-iframe" src="/calendar" title="Calendario" sandbox="allow-same-origin allow-scripts allow-forms"></iframe>
  </div>
  <button id="cw-close-btn" class="cw-close" title="Cerrar">‚úï</button>
</div>

  <script id="initial-data" type="application/json">{{ (musicals | default([])) | tojson }}</script>
  <script>
    const INITIAL_MUSICALS = JSON.parse(document.getElementById('initial-data').textContent || '[]');
  </script>
  <!-- main script -->
  <script src="{{ url_for('static', filename='main.js') }}"></script>
  <script>
    // show Telegram popup on first visit (remember choice in localStorage)
    (function(){
      const KEY = 'telegramPopupSeen_v1';
      if (localStorage.getItem(KEY)) return;
      const popup = document.getElementById('telegram-popup');
      if (!popup) return;
      // show with small delay so it doesn't feel abrupt
      setTimeout(() => {
        popup.classList.add('show');
        popup.style.opacity = 1;
        popup.style.pointerEvents = 'auto';
        popup.setAttribute('aria-hidden','false');
      }, 700);

      function hideAndRemember() {
        try { localStorage.setItem(KEY, '1'); } catch(e){}
        popup.classList.remove('show');
        popup.style.opacity = 0;
        popup.style.pointerEvents = 'none';
        popup.setAttribute('aria-hidden','true');
      }

      document.getElementById('telegram-join').addEventListener('click', () => {
        hideAndRemember();
        // allow anchor to open in new tab (already target="_blank")
      });
      document.getElementById('telegram-dismiss').addEventListener('click', (e) => { e.preventDefault(); hideAndRemember(); });
      document.getElementById('telegram-close').addEventListener('click', (e) => { e.preventDefault(); hideAndRemember(); });
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') hideAndRemember(); });
    })();
  </script>
  <script>
  (function(){
    // safe init: test-telegram (if existe) y control del modal de sugerencias (idempotente)
    try {
      // Test Telegram button (safe)
      const testBtn = document.getElementById('test-telegram-btn');
      if (testBtn && !testBtn.dataset.init) {
        testBtn.dataset.init = '1';
        testBtn.addEventListener('click', async () => {
          try {
            const res = await fetch('/admin/test-telegram', { method: 'POST' });
            const j = await res.json().catch(()=>({ok:false}));
            alert('Telegram test: ' + (j.ok ? 'OK' : JSON.stringify(j)));
          } catch (e) {
            alert('Error: ' + e);
          }
        });
      }

      // Suggestion modal controls (ensure close works even if main.js crashed)
      const modal = document.getElementById('suggest-modal');
      if (modal && !modal.dataset.safeInit) {
        modal.dataset.safeInit = '1';
        const openBtn = document.getElementById('open-suggest');
        const closeBtn = document.getElementById('suggest-close');
        const cancelBtn = document.getElementById('suggest-cancel');
        const form = document.getElementById('suggest-form');
        const status = document.getElementById('suggest-status');

        const show = (v = true) => {
          modal.style.display = v ? 'block' : 'none';
          modal.setAttribute('aria-hidden', v ? 'false' : 'true');
        };
        if (openBtn) openBtn.addEventListener('click', () => show(true));
        if (closeBtn) closeBtn.addEventListener('click', () => show(false));
        if (cancelBtn) cancelBtn.addEventListener('click', () => show(false));
        document.addEventListener('keydown', e => { if (e.key === 'Escape') show(false); });

        // Basic submit fallback (in case main.js handler not attached)
        if (form && !form.dataset.safeSubmit) {
          form.dataset.safeSubmit = '1';
          form.addEventListener('submit', async (ev) => {
            ev.preventDefault();
            if (status) status.textContent = 'Enviando‚Ä¶';
            const fd = new FormData(form);
            const payload = {
              name: (fd.get('name') || '').trim(),
              email: (fd.get('email') || '').trim(),
              message: (fd.get('message') || '').trim()
            };
            if (!payload.message) { if (status) status.textContent = 'Escribe un mensaje.'; return; }
            try {
              const res = await fetch('/suggest', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
              const j = await res.json().catch(()=>({ok:false}));
              if (res.ok && j.ok) {
                if (status) status.textContent = '¬°Gracias! Enviado.';
                setTimeout(()=>{ if (status) status.textContent=''; show(false); form.reset(); }, 1200);
              } else {
                if (status) status.textContent = 'Error: ' + (j.error || j.body || res.statusText);
              }
            } catch (e) {
              if (status) status.textContent = 'Error de red';
            }
          });
        }
      }
    } catch (err) {
      console.error('Safe inline init failed', err);
    }
  })();
  </script>
</body>
</html>