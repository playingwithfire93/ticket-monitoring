<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸŸï¸ Ticket Monitor Dashboard</title>
  
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body class="pink-theme">

  <!-- Header Ãºnico -->
  <header class="topbar">
    <div class="container topbar-inner">
      <div class="brand">
        <div class="logo-badge" aria-hidden="true">ğŸŸï¸</div>
        <h1>Ticket Monitor</h1>
        <p class="subtitle">Cute & dynamic musical watcher</p>
      </div>
 
      <div class="controls">
        <div class="search-wrap">
          <span class="search-icon" aria-hidden="true">ğŸ”</span>
          <input id="search" placeholder="Buscar musical..." />
        </div>
        <label class="auto-refresh" aria-live="polite">
          <span class="ar-label">Auto-refresh</span>
          <label class="toggle-switch" title="Auto-refresh">
            <input id="toggle-refresh" type="checkbox" checked />
            <span class="switch" aria-hidden="true"></span>
          </label>
          <span id="ar-state" class="ar-state">ON</span>
        </label>
        <div class="last-checked">â±ï¸ <small class="lc-label">Last Checked</small> <span id="last-checked">--</span></div>
        <div class="last-checked">ğŸ“ <small class="lc-label">Ãšltimos cambios</small> <span id="last-changes">--</span></div>
        <a href="/shows" class="btn small" style="text-decoration:none">Ver cartelera</a>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Hero Banner -->
    <div class="catalog-hero">
      <div class="catalog-hero-inner">
        <h1>ğŸ­ Ticket Monitor</h1>
        <p class="lead">Monitorea disponibilidad de entradas para musicales en tiempo real</p>
        
        <div class="header-actions">
          <a href="{{ telegram_url }}" target="_blank" class="btn btn-telegram">
            <span class="icon">ğŸ“±</span> Ãšnete a Telegram
          </a>
          <a href="{{ discord_url }}" target="_blank" class="btn btn-discord">
            <span class="icon">ğŸ’¬</span> Ãšnete a Discord
          </a>
        </div>
      </div>
    </div>

    <!-- Dashboard Content con Cards -->
    <section class="dashboard-section">
      <div class="section-header">
        <h2>ğŸª Musicales Monitoreados</h2>
        <p class="section-subtitle">{{ musicals|length }} musicales en seguimiento</p>
      </div>

      {% if musicals %}
      <div class="musicals-grid">
        {% for musical in musicals %}
        <article class="musical-card" data-musical-id="{{ musical.id }}">
          <!-- Placeholder para imÃ¡genes -->
          <div class="musical-slideshow">
            <div class="slideshow-placeholder">
              <div class="placeholder-icon">ğŸ­</div>
              <p>{{ musical.name }}</p>
            </div>
          </div>

          <!-- Header de la card -->
          <div class="musical-card-header">
            <h3 class="musical-title">{{ musical.name }}</h3>
            <div class="badges">
              {% if musical.is_available %}
              <span class="badge badge-success">âœ… Disponible</span>
              {% else %}
              <span class="badge badge-danger">âŒ Agotado</span>
              {% endif %}
            </div>
          </div>
          
          <!-- Body de la card -->
          <div class="musical-card-body">
            <div class="musical-stats">
              <div class="stat">
                <span class="stat-icon">ğŸ”—</span>
                <div class="stat-info">
                  <span class="stat-label">Total Enlaces</span>
                  <span class="stat-value">{{ musical.links|length }}</span>
                </div>
              </div>
              
              <div class="stat">
                <span class="stat-icon">âœ…</span>
                <div class="stat-info">
                  <span class="stat-label">Disponibles</span>
                  <span class="stat-value">{{ musical.active_links }}</span>
                </div>
              </div>

              <div class="stat">
                <span class="stat-icon">âŒ</span>
                <div class="stat-info">
                  <span class="stat-label">Agotados</span>
                  <span class="stat-value">{{ musical.sold_out_links }}</span>
                </div>
              </div>
            </div>

            <!-- Enlaces monitoreados -->
            <div class="musical-links">
              <h4 class="links-title">
                <span class="icon">ğŸ«</span> 
                Enlaces monitoreados ({{ musical.links|length }})
              </h4>
              <ul class="links-list">
                {% for link in musical.links[:3] %}
                <li>
                  <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer" class="link-item">
                    <span class="link-icon">ğŸ”—</span>
                    <span class="link-text">{{ link.url|replace('https://', '')|replace('http://', '')|truncate(43, True, '...') }}</span>
                    {% if link.is_available %}
                    <span class="status-badge available">âœ…</span>
                    {% else %}
                    <span class="status-badge sold-out">âŒ</span>
                    {% endif %}
                    <span class="link-external">â†—</span>
                  </a>
                </li>
                {% endfor %}
                
                {% if musical.links|length > 3 %}
                <li class="more-links">
                  <button class="btn-text" onclick="toggleAllLinks(this)">
                    Ver {{ musical.links|length - 3 }} enlaces mÃ¡s...
                  </button>
                </li>
                {% endif %}
              </ul>
              
              {% if musical.links|length > 3 %}
              <ul class="links-list-extra" style="display:none;">
                {% for link in musical.links[3:] %}
                <li>
                  <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer" class="link-item">
                    <span class="link-icon">ğŸ”—</span>
                    <span class="link-text">{{ link.url|replace('https://', '')|replace('http://', '')|truncate(43, True, '...') }}</span>
                    {% if link.is_available %}
                    <span class="status-badge available">âœ…</span>
                    {% else %}
                    <span class="status-badge sold-out">âŒ</span>
                    {% endif %}
                    <span class="link-external">â†—</span>
                  </a>
                </li>
                {% endfor %}
              </ul>
              {% endif %}
            </div>

            {% if musical.updated_at %}
            <div class="last-change">
              <span class="change-icon">ğŸ“</span>
              <span class="change-text">Actualizado: {{ musical.updated_at.strftime('%d/%m/%Y %H:%M') }}</span>
            </div>
            {% endif %}
          </div>

          <!-- Footer de la card -->
          <div class="musical-card-footer">
            <a href="/shows#musical-{{ musical.id }}" class="btn btn-primary">
              <span>Ver detalles completos</span>
              <span class="btn-icon">â†’</span>
            </a>
          </div>
        </article>
        {% endfor %}
      </div>
      {% else %}
      <div class="empty-state">
        <div class="empty-icon">ğŸ­</div>
        <h3>No hay musicales monitoreados</h3>
        <p>AÃ±ade tu primer musical para empezar a monitorear entradas</p>
        <button class="btn btn-primary" onclick="document.getElementById('inline-suggest').scrollIntoView({behavior: 'smooth'})">
          <span class="icon">âœ¨</span>
          Sugerir Musical
        </button>
      </div>
      {% endif %}
    </section>

    <!-- Quick Stats -->
    <section class="stats-section">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">ğŸ«</div>
          <div class="stat-content">
            <h4>Total Enlaces</h4>
            <p class="stat-number">
              {% set total = namespace(value=0) %}
              {% for musical in musicals %}
                {% set total.value = total.value + musical.links|length %}
              {% endfor %}
              {{ total.value }}
            </p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">ğŸª</div>
          <div class="stat-content">
            <h4>Musicales</h4>
            <p class="stat-number">{{ musicals|length }}</p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">âš¡</div>
          <div class="stat-content">
            <h4>Estado</h4>
            <p class="stat-status">âœ… Activo</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Inline suggestion card -->
    <section id="inline-suggest" class="suggestion-card fade-in" aria-labelledby="suggest-inline-title">
      <h3 id="suggest-inline-title">ğŸ’Œ Enviar sugerencia</h3>
      <form id="inline-suggest-form" class="suggestion-form" novalidate>
        <div class="row">
          <label>Nombre del Musical *<br>
            <input name="siteName" type="text" placeholder="Ej. The Book of Mormon" required>
          </label>
          <label>URL del sitio *<br>
            <input name="siteUrl" type="url" placeholder="https://tickets.ejemplo.com" required>
          </label>
        </div>

        <label>Â¿Por quÃ© deberÃ­amos monitorearlo?<br>
          <textarea name="reason" rows="3" placeholder="Opcional: cuÃ©ntanos por quÃ© te interesa este musical..."></textarea>
        </label>

        <div class="suggest-controls">
          <button type="submit" class="btn primary">âœ¨ Enviar Sugerencia</button>
          <button type="reset" class="btn ghost">Limpiar</button>
          <div id="inline-suggest-status" class="suggest-status" aria-live="polite"></div>
        </div>
      </form>
    </section>
  </main>

  <footer class="footer">
    <small>Made with ğŸ’– â€” dynamic cute monitor</small>
  </footer>

  <!-- Scripts -->
  <script src="{{ url_for('static', filename='main.js') }}"></script>
  <script>
    // ==================== TOGGLE EXTRA LINKS ====================
    function toggleAllLinks(button) {
      const card = button.closest('.musical-card');
      const extraLinks = card.querySelector('.links-list-extra');
      
      if (extraLinks.style.display === 'none') {
        extraLinks.style.display = 'block';
        button.textContent = 'Ver menos...';
      } else {
        extraLinks.style.display = 'none';
        const hiddenCount = extraLinks.querySelectorAll('li').length;
        button.textContent = `Ver ${hiddenCount} enlaces mÃ¡s...`;
      }
    }

    // ==================== SUGGESTION FORM ====================
    document.getElementById('inline-suggest-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const status = document.getElementById('inline-suggest-status');
      const form = e.target;
      
      const data = {
        siteName: form.siteName.value.trim(),
        siteUrl: form.siteUrl.value.trim(),
        reason: form.reason.value.trim()
      };
      
      if (!data.siteName || !data.siteUrl) {
        status.textContent = 'âš ï¸ Por favor completa los campos obligatorios';
        status.style.color = '#dc3545';
        return;
      }
      
      status.textContent = 'â³ Enviando...';
      status.style.color = '#6c757d';
      
      try {
        const res = await fetch('/api/suggest-site', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await res.json();
        
        if (res.ok && result.ok) {
          status.textContent = 'âœ… Â¡Gracias! Tu sugerencia ha sido enviada';
          status.style.color = '#28a745';
          form.reset();
          setTimeout(() => { status.textContent = ''; }, 3000);
        } else {
          status.textContent = 'âŒ Error: ' + (result.error || 'Intenta de nuevo');
          status.style.color = '#dc3545';
        }
      } catch (err) {
        status.textContent = 'âŒ Error de conexiÃ³n';
        status.style.color = '#dc3545';
      }
    });
  </script>
</body>
</html>