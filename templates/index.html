<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>🎟️ Ticket Monitor Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="pink-theme">
  <header class="topbar">
    <div class="container topbar-inner">
      <div class="brand">
        <!-- cute rounded badge (fallback to emoji) -->
        <div class="logo-badge" aria-hidden="true">🎟️</div>
         <h1>Ticket Monitor</h1>
         <p class="subtitle">Cute & dynamic musical watcher</p>
       </div>
 
       <div class="controls">
        <div class="search-wrap">
          <span class="search-icon" aria-hidden="true">🔎</span>
          <input id="search" placeholder="Buscar musical..." />
        </div>
        <label class="auto-refresh" aria-live="polite">
          <span class="ar-label">Auto-refresh</span>
          <label class="toggle-switch" title="Auto-refresh">
            <input id="toggle-refresh" type="checkbox" checked />
            <span class="switch" aria-hidden="true"></span>
          </label>
          <span id="ar-state" class="ar-state">ON</span>
        </label>
         <div class="last-checked">⏱️ <small class="lc-label">Last Checked</small> <span id="last-checked">--</span></div>
         <div class="last-checked">📝 <small class="lc-label">Últimos cambios</small> <span id="last-changes">--</span></div>
        <a href="/shows" class="btn small" style="text-decoration:none">Ver cartelera</a>
        <button id="test-telegram-btn" class="btn small telegram-btn"><span class="tg-icon" aria-hidden="true">✈️</span> Test Telegram</button>
       </div>
     </div>
   </header>

  <main class="container">

    <!-- Table / List -->
    <section id="list" class="list-section fade-in">
      <table class="musicals-table" aria-label="Monitored musicals" style="display:none">
        <thead>
          <tr>
            <th aria-hidden="true"></th>
            <th>Musical</th>
            <th>URLs</th>
            <th>Cambios</th>
          </tr>
        </thead>
        <tbody id="table-body">
          <!-- populated by main.js -->
        </tbody>
      </table>

      <div id="no-data" class="no-data" hidden>No musicals yet — add one ✨</div>
    </section>

    <!-- Cards Grid -->
    <section id="cards" class="cards-section fade-in" aria-labelledby="cards-title">
      <h2 id="cards-title" class="visually-hidden">Monitored musicals (cards)</h2>
      <div id="cards-grid" class="monitor-cards">
        {% for item in musicals %}
        <article class="show-card" data-musical="{{ item.name }}">
          <div class="card-image-wrap">
            <!-- ...existing carousel code... -->
          </div>
          <div class="card-body">
            <h3 class="card-title">{{ item.name }}</h3>
            
            <!-- NUEVO: Mostrar última actualización -->
            <div class="card-meta-row">
              <p class="card-meta">
                {{ item.total_links }} URL{{ 's' if item.total_links != 1 else '' }} 
                · +0 ⚠ 0
              </p>
              {% if item.last_updated %}
              <p class="card-last-update" title="Última actualización">
                🕒 {{ format_date(item.last_updated) }}
              </p>
              {% endif %}
            </div>
            
            <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
              <div class="progress-fill" style="width:0%"></div>
            </div>
          </div>
        </article>
        {% endfor %}
      </div>
    </section>

    <!-- Inline suggestion card (non-overlay) -->
    <section id="inline-suggest" class="suggestion-card fade-in" aria-labelledby="suggest-inline-title">
      <h3 id="suggest-inline-title">Enviar sugerencia</h3>
      <form id="inline-suggest-form" class="suggestion-form" novalidate>
        <div class="row">
          <label>Nombre (opcional)<br><input name="name" type="text" placeholder="Tu nombre"></label>
          <label>Email (opcional)<br><input name="email" type="email" placeholder="tu@correo.com"></label>
        </div>

        <div class="row">
          <label>Musical<br><input name="musical" type="text" placeholder="Ej. The Book of Mormon"></label>
          <label>Link<br><input name="url" type="url" placeholder="https://tickets.ejemplo.com/..."></label>
        </div>

        <label>Comentario / mensaje<br><textarea name="comment" rows="4" required placeholder="Escribe tu sugerencia o comentario..."></textarea></label>

        <div class="suggest-controls">
          <button type="submit" class="btn primary">Enviar</button>
          <button type="reset" class="btn ghost">Limpiar</button>
          <div id="inline-suggest-status" class="suggest-status" aria-live="polite"></div>
        </div>
      </form>
    </section>
  </main>

  <!-- Modal para mostrar cambios (necesario para showChangesForItem) -->
  <div id="modal" class="modal" aria-hidden="true" style="display:none;">
    <div class="modal-inner" role="dialog" aria-modal="true" aria-labelledby="modal-title" style="max-width:820px;">
      <button id="modal-close" class="modal-close" aria-label="Cerrar" style="position:absolute;right:12px;top:10px;background:transparent;border:0;font-size:20px;cursor:pointer">×</button>
      <h3 id="modal-title" style="margin:0 0 .5rem 0;font-size:1.05rem;font-weight:700"></h3>
      <div id="modal-list"></div>
    </div>
  </div>

  <footer class="footer">
    <small>Made with 💖 — dynamic cute monitor</small>
  </footer>

  <!-- Join Channels Popup (añadir antes de </body>) -->
  <div id="join-channels-popup" class="join-popup" style="display:none;">
    <div class="join-popup-overlay"></div>
    <div class="join-popup-inner">
      <button class="join-close" id="join-close-btn" aria-label="Cerrar" type="button">✕</button>
      
      <div class="join-header">
        <h2>🎭 ¡Bienvenido a Ticket Monitor!</h2>
        <p>Únete a nuestra comunidad para recibir alertas instantáneas</p>
      </div>
      
      <div class="join-channels">
        <a href="https://t.me/TheBookOfMormonTicketsbot" 
           target="_blank" 
           rel="noopener noreferrer" 
           class="join-btn telegram"
           onclick="localStorage.setItem('joinChannelsShown_v1', 'true')">
          <svg class="join-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.14.18-.357.295-.6.295-.002 0-.003 0-.005 0l.213-3.053 5.56-5.023c.242-.213-.054-.334-.373-.121l-6.869 4.326-2.96-.924c-.64-.203-.658-.64.135-.954l11.566-4.458c.538-.196 1.006.128.832.941z"/>
          </svg>
          <span>Bot de Telegram</span>
        </a>
        
        <a href="https://discord.gg/wQgsmkTe" 
           target="_blank" 
           rel="noopener noreferrer" 
           class="join-btn discord"
           onclick="localStorage.setItem('joinChannelsShown_v1', 'true')">
          <svg class="join-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
          </svg>
          <span>Servidor de Discord</span>
        </a>
      </div>
      
      <button class="join-skip" id="join-skip-btn" type="button">
        Recordar más tarde
      </button>
    </div>
  </div>

  <script id="initial-data" type="application/json">{{ (musicals | default([])) | tojson }}</script>
  <script>
    const INITIAL_MUSICALS = JSON.parse(document.getElementById('initial-data').textContent || '[]');
  </script>
  <!-- main script -->
  <script src="{{ url_for('static', filename='main.js') }}"></script>
  <script>
  (function(){
    // safe init: test-telegram (if existe) y control del modal de sugerencias (idempotente)
    try {
      // Test Telegram button (safe)
      const testBtn = document.getElementById('test-telegram-btn');
      if (testBtn && !testBtn.dataset.init) {
        testBtn.dataset.init = '1';
        testBtn.addEventListener('click', async () => {
          try {
            const res = await fetch('/admin/test-telegram', { method: 'POST' });
            const j = await res.json().catch(()=>({ok:false}));
            alert('Telegram test: ' + (j.ok ? 'OK' : JSON.stringify(j)));
          } catch (e) {
            alert('Error: ' + e);
          }
        });
      }

      // Suggestion modal controls (ensure close works even if main.js crashed)
      const modal = document.getElementById('suggest-modal');
      if (modal && !modal.dataset.safeInit) {
        modal.dataset.safeInit = '1';
        const openBtn = document.getElementById('open-suggest');
        const closeBtn = document.getElementById('suggest-close');
        const cancelBtn = document.getElementById('suggest-cancel');
        const form = document.getElementById('suggest-form');
        const status = document.getElementById('suggest-status');

        const show = (v = true) => {
          modal.style.display = v ? 'block' : 'none';
          modal.setAttribute('aria-hidden', v ? 'false' : 'true');
        };
        if (openBtn) openBtn.addEventListener('click', () => show(true));
        if (closeBtn) closeBtn.addEventListener('click', () => show(false));
        if (cancelBtn) cancelBtn.addEventListener('click', () => show(false));
        document.addEventListener('keydown', e => { if (e.key === 'Escape') show(false); });

        // Basic submit fallback (in case main.js handler not attached)
        if (form && !form.dataset.safeSubmit) {
          form.dataset.safeSubmit = '1';
          form.addEventListener('submit', async (ev) => {
            ev.preventDefault();
            if (status) status.textContent = 'Enviando…';
            const fd = new FormData(form);
            const payload = {
              name: (fd.get('name') || '').trim(),
              email: (fd.get('email') || '').trim(),
              message: (fd.get('message') || '').trim()
            };
            if (!payload.message) { if (status) status.textContent = 'Escribe un mensaje.'; return; }
            try {
              const res = await fetch('/suggest', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
              const j = await res.json().catch(()=>({ok:false}));
              if (res.ok && j.ok) {
                if (status) status.textContent = '¡Gracias! Enviado.';
                setTimeout(()=>{ if (status) status.textContent=''; show(false); form.reset(); }, 1200);
              } else {
                if (status) status.textContent = 'Error: ' + (j.error || j.body || res.statusText);
              }
            } catch (e) {
              if (status) status.textContent = 'Error de red';
            }
          });
        }
      }
    } catch (err) {
      console.error('Safe inline init failed', err);
    }
  })();
  </script>
</body>
</html>